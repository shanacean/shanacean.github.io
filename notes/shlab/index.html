<!DOCTYPE html>
<html lang=""><head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <title>Shlab</title>
    <meta name="description" content="A simple monospaced resume theme for Hugo.">
    <meta name="author" content='Bangyang Shan'>

    
    <link href="https://fonts.googleapis.com/css2?family=Inconsolata:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/css/bootstrap.min.css" integrity="sha384-TX8t27EcRE3e/ihU7zmQxVncDAy5uIKz4rEkgIXeMed4M0jlfIDPvg6uqKI2xXr2" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css" integrity="sha512-iBBXm8fW90+nuLcSKlbmrPcLa0OT92xO1BIsZ+ywDWZCvqsWgccV3gFoRBv0z+8dLJgyAHIhR35VZc2oM/gI1w==" crossorigin="anonymous">
    
    
    
    

    
    <link rel="stylesheet" href="/sass/researcher.min.css">

    
        <link rel="icon" type="image/ico" href="https://shanacean.github.io/img/favicon.ico">
    

    
        
    
</head>

    <body><div class="container mt-5">
    <nav class="navbar navbar-expand-sm flex-column flex-sm-row text-nowrap p-0">
        <a class="navbar-brand mx-0 mr-sm-auto" href="https://shanacean.github.io" title="Bangyang Shan">
          
          Bangyang Shan
        </a>
        <div class="navbar-nav flex-row flex-wrap justify-content-center">
            
                
                
                    <a class="nav-item nav-link" href="/" title="About">
                        About
                    </a>
                    
                        <span class="nav-item navbar-text mx-1">/</span>
                    
                
                    <a class="nav-item nav-link" href="/notes" title="Notes">
                        Notes
                    </a>
                    
                        <span class="nav-item navbar-text mx-1">/</span>
                    
                
                    <a class="nav-item nav-link" href="/reading" title="Reading">
                        Reading
                    </a>
                    
                        <span class="nav-item navbar-text mx-1">/</span>
                    
                
                    <a class="nav-item nav-link" href="/tags" title="Tags">
                        Tags
                    </a>
                    
                
            
        </div>
    </nav>
</div>
<hr>
<div id="content">
<div class="container">
    <h2 id="shell-lab">Shell Lab</h2>
<h3 id="csapp-chapter8-exceptional-control-flow">CSAPP Chapter8 Exceptional Control Flow</h3>
<p><strong>异常分类</strong>:
<img src="/system/shell/exceptional.png" alt=""></p>
<blockquote>
<p>Trap是用户态向内核请求服务的过程，提供<code>syscall n</code>接口，即系统调用。<br>
系统为异常分配了唯一的非负整数异常号，系统启动时，操作系统初始化一张异常表，起始地址存放在异常表基址寄存器中。异常处理流程如下:
<img src="/system/shell/exceptional-flow.png" alt=""></p>
</blockquote>
<p><strong>并发流、并行流:</strong></p>
<ul>
<li>逻辑流在执行时间上有重叠即为并发流</li>
<li>运行在不同处理器核上的并发流为并行流</li>
</ul>
<p><code>pid_t fork(void);</code></p>
<ul>
<li>创建父进程的副本，返回两次，若为0则在子进程中，反之在父进程中。 - 共享文件描述符</li>
</ul>
<p><code>pid_t waitpid(pid_t pid, int *statusup, int options);</code></p>
<ul>
<li>等待进程号为pid的子进程执行结束，<code>waitpid(pid, NULL, 0)</code>, statusup、options翻阅man文档</li>
<li>返回值为pid则成功，-1则执行错误</li>
</ul>
<p>命令行参数、环境变量参数示意图:</p>
<blockquote>
<p>全局变量 envrion 指向envp[0]
<img src="/system/shell/args.jpg" alt=""></p>
</blockquote>
<p><strong>信号</strong>
信号机制基于进程组，每个进程都属于一个进程组<br></p>
<p><code>pid_t getpgrp(void);</code>
<code>int setpgrp(pid_t pid, pid_t pgrd);</code></p>
<ul>
<li>获取进程组、修改进程组</li>
</ul>
<p>发送信号:<br>
<code>int kill(pid_t pid, int sig);</code></p>
<ul>
<li>pid &gt; 0, sig to pid</li>
<li>pid = 0, sig to pids in group of pid</li>
<li>pid &lt; 0, sig to pids in |pid|</li>
</ul>
<p><code>unsigned int alarm(unsigned int secs);</code></p>
<ul>
<li>向自己发送SIGALRM信号</li>
</ul>
<p>接受信号:<br></p>
<ul>
<li>pending: 待处理信号向量</li>
<li>blocked: 被阻塞的信号向量
当发送上下文切换或系统调用返回时，会检查(pending &amp; ~blocked)，选择待处理信号最小的信号接收，如果为空则Inext</li>
</ul>
<pre><code>#include &lt;signal.h&gt;
typedef void (*sighandler_t)(int);
sighandler_t signal(int signum, sighandler_t handler);
</code></pre><ul>
<li>if handler == SIG_IGN, ignore signum</li>
<li>if handler == SIG_DFL, restore signum</li>
<li>else handler 为用户自定义信号处理函数</li>
</ul>
<blockquote>
<p>handler 可以被 handler中断，即在handler中处理handler</p>
</blockquote>
<p>信号处理流程:<br>
<img src="/system/shell/signal_process.jpg" alt=""></p>
<p><strong>阻塞、解除阻塞信号</strong></p>
<pre><code>#include &lt;signal.h&gt;
// success -&gt; 0, error -&gt; -1
int sigprocmask(int how, const sigset_t *set, sigset_t *oldset);
int sigemptyset(sigset_t *set);
int sigfillset(sigset_t *set);
int sigaddset(sigset_t *set, int signum);
int sigdelset(sigset_t *set, int signum);

// if signum in set -&gt; 1, else -&gt; 0, error -&gt; -1
int sigismember(const sigset_t *set, int signum);
// 
</code></pre><ul>
<li>how
<ul>
<li>SIG_BLOCK: blocked = blocked | set</li>
<li>SIG_UNBLOCK: blocked = blocked &amp; ~set</li>
<li>SIG_SETMASK: blocked = set</li>
</ul>
</li>
</ul>
<hr>
<h3 id="task1">Task1</h3>
<p>完成trace01、trace02<br>
根据注释可知，输入的每条指令的过程为 <code>eval</code> -&gt; <code>parseline</code><br>
trace01为读取txt至eof结束，样例代码已经实现
trace02为读取内置quit命令退出，实现如下</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">eval</span>(<span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>cmdline) {
  <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>argv[MAXLINE];
  parseline(cmdline, argv);
  builtin_cmd(argv);
  <span style="color:#66d9ef">return</span>;
}

<span style="color:#66d9ef">int</span> <span style="color:#a6e22e">builtin_cmd</span>(<span style="color:#66d9ef">char</span> <span style="color:#f92672">**</span>argv) {
  <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span>strcmp(argv[<span style="color:#ae81ff">0</span>], <span style="color:#e6db74">&#34;quit&#34;</span>))
    exit(<span style="color:#ae81ff">0</span>);
  <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>; <span style="color:#75715e">/* not a builtin command */</span>
}
</code></pre></div><h3 id="task2">Task2</h3>
<p>完成trace03验证quit命令。<br>
对<code>eval</code>代码进行修改。<br>
遇到非built-in命令，fork一个子进程执行execve命令, environ为全局变量，存储系统环境变量。</p>
<blockquote>
<p>运行foreground命令时，主程序等待其执行结束再return。</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">eval</span>(<span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>cmdline) {
  <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>argv[MAXLINE];
  <span style="color:#66d9ef">int</span> pid;
  <span style="color:#66d9ef">int</span> bg;

  bg <span style="color:#f92672">=</span> parseline(cmdline, argv);
  <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span>builtin_cmd(argv)) {
    <span style="color:#66d9ef">if</span> ((pid <span style="color:#f92672">=</span> fork()) <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>) {
      <span style="color:#66d9ef">if</span> (execve(argv[<span style="color:#ae81ff">0</span>], argv, environ) <span style="color:#f92672">==</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>)
        unix_error(<span style="color:#e6db74">&#34;execv&#34;</span>);
    }
    <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span>bg) {
      <span style="color:#66d9ef">if</span> (waitpid(pid, NULL, <span style="color:#ae81ff">0</span>) <span style="color:#f92672">==</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>)
        unix_error(<span style="color:#e6db74">&#34;waitpid&#34;</span>);
    }
  }
  <span style="color:#66d9ef">return</span>;
}
</code></pre></div><h3 id="task3">Task3</h3>
<p>完成trace04验证<br></p>

</div>

        </div><div id="footer" class="mb-5">
    <hr>
    <div class="container text-center">
        
            <a href="https://github.com/shanacean" class="fab fa-github fa-1x" title="Github"></a>
        
            <a href="mailto:bangyangdan@gmail.com" class="fas fa-envelope fa-1x" title="Gmail"></a>
        
    </div>
    
</div>
</body>
</html>
